package com.vedidev.nativebridge;import com.google.android.gms.ads.InterstitialAd;import com.google.android.gms.ads.AdView;import com.google.android.gms.ads.AdSize;import com.google.android.gms.ads.AdRequest;import com.google.android.gms.ads.*;import android.app.Activity;import android.content.Context;import android.graphics.Color;import android.util.Log;import android.view.ViewGroup.LayoutParams;import android.widget.RelativeLayout;import android.view.Gravity;import android.view.View;import android.os.Handler;import org.json.JSONObject;/** * @author smallkot *         date 19/12/14 */@SuppressWarnings("UnusedDeclaration")public class AdmobBunch implements Bunch {    private static final String TAG = "AdMobBridge";    private static AdmobBunch _admobBunch;    private AdView adView;    private static RelativeLayout _layout = null;    private RelativeLayout _bannerLayout = null;    final private static int kGADAdSizeInvalid = 0;    final private static int kGADAdSizeBanner = 1;    final private static int kGADAdSizeMediumRectangle = 2;    final private static int kGADAdSizeFullBanner = 3;    final private static int kGADAdSizeLeaderboard = 4;    final private static int kGADAdSizeSkyscraper = 5;    final private static int kGADAdSizeSmartBannerPortrait = 6;    final private static int kGADAdSizeSmartBannerLandscape = 7;    private static final int kBannerGravityNone = -1;    private static final int kBannerGravityTopLeft = 0;    private static final int kBannerGravityCenterLeft = 1;    private static final int kBannerGravityBottomLeft = 2;    private static final int kBannerGravityTopCenter = 3;    private static final int kBannerGravityCenter = 4;    private static final int kBannerGravityBottomCenter = 5;    private static final int kBannerGravityTopRight = 6;    private static final int kBannerGravityCenterRight = 7;    private static final int kBannerGravityBottomRight = 8;    private Context context;    private Activity activity;    private InterstitialAd interstitial = null;    private static long lastAttemptTime = System.currentTimeMillis();    public AdmobBunch() {        registerProcessor("createBanner", new ProcessorEngine.CallHandler() {            @Override            public void handle(JSONObject params, JSONObject retParams) throws Exception {                String adUnitID = params.getString("adUnitID");                int adSizeBanner = params.getInt("adSizeBanner");                createBanner(adUnitID, adSizeBanner);            }        });        registerProcessor("showBanner", new ProcessorEngine.CallHandler() {            @Override            public void handle(JSONObject params, JSONObject retParams) throws Exception {                int mX = params.getInt("mX");                int mY = params.getInt("mY");                int mWidth = params.getInt("mWidth");                int mHeight = params.getInt("mHeight");                int mGravity = params.getInt("mGravity");                showBanner(mX, mY, mWidth, mHeight, mGravity);            }        });        registerProcessor("hideBanner", new ProcessorEngine.CallHandler() {            @Override            public void handle(JSONObject params, JSONObject retParams) throws Exception {                hideBanner();            }        });        registerProcessor("createInterstitial", new ProcessorEngine.CallHandler() {            @Override            public void handle(JSONObject params, JSONObject retParams) throws Exception {                String adUnitID = params.getString("adUnitID");                createInterstitial(adUnitID);            }        });        registerProcessor("showInterstitial", new ProcessorEngine.CallHandler() {            @Override            public void handle(JSONObject params, JSONObject retParams) throws Exception {                showInterstitial();            }        });    }    private void createBanner(final String adUnitID, final int size) {        _admobBunch = this;        if(this.activity!=null)        {            this.activity.runOnUiThread(new Runnable() {                @Override                public void run() {                    AdSize bannerSize = AdSize.BANNER;                    switch(size)                    {                        case kGADAdSizeBanner:                            bannerSize = AdSize.BANNER;                            break;                        case kGADAdSizeMediumRectangle:                            bannerSize = AdSize.MEDIUM_RECTANGLE;                            break;                        case kGADAdSizeFullBanner:                            bannerSize = AdSize.FULL_BANNER;                            break;                        case kGADAdSizeLeaderboard:                            bannerSize = AdSize.LEADERBOARD;                            break;                        case kGADAdSizeSkyscraper:                            bannerSize = AdSize.WIDE_SKYSCRAPER;                            break;                        case kGADAdSizeSmartBannerPortrait:                            bannerSize = AdSize.SMART_BANNER;                            break;                        case kGADAdSizeSmartBannerLandscape:                            bannerSize = AdSize.SMART_BANNER;                            break;                        case kGADAdSizeInvalid:                        default:                            break;                    }                    _admobBunch.adView = new AdView(_admobBunch.activity);                    _admobBunch.adView.setAdSize(bannerSize);                    _admobBunch.adView.setAdUnitId(adUnitID);                    AdRequest adRequest = new AdRequest.Builder()                            .addTestDevice(AdRequest.DEVICE_ID_EMULATOR)                            .addTestDevice("HASH_DEVICE_ID")                            .build();                    _admobBunch.adView.loadAd(adRequest);                    _admobBunch.adView.setBackgroundColor(Color.BLACK);                    _admobBunch.adView.setBackgroundColor(0);                }            });        }    }    public void hideBanner()    {        _admobBunch.activity.runOnUiThread(new Runnable() {            @Override            public void run() {                _admobBunch.adView.setVisibility(View.INVISIBLE);            }        });    }    public void showBanner(final int x, final int y, final int width, final int height, final int theGravity)    {        _admobBunch.activity.runOnUiThread(new Runnable() {            @Override            public void run() {                _admobBunch.adView.setVisibility(View.VISIBLE);                if (_layout != null && _admobBunch._bannerLayout != null && _admobBunch.adView.getParent() != null) {                    _admobBunch._bannerLayout.removeView(_admobBunch.adView);                    _layout.removeView(_admobBunch._bannerLayout);                    _admobBunch._bannerLayout = null;                }                if (_layout == null) {                    _layout = new RelativeLayout(_admobBunch.activity);                    _admobBunch.activity.addContentView(_layout, new LayoutParams(LayoutParams.MATCH_PARENT, LayoutParams.MATCH_PARENT));                    _layout.setGravity(Gravity.TOP | Gravity.START);                }                if (_admobBunch.adView.getParent() == null) {                    _admobBunch._bannerLayout = new RelativeLayout(_admobBunch.activity);                    RelativeLayout.LayoutParams params = new RelativeLayout.LayoutParams(width, height);                    if (theGravity == -1) {                        params.leftMargin = x;                        params.topMargin = y;                    }                    _layout.addView(_admobBunch._bannerLayout, params);                    switch (theGravity) {                        case kBannerGravityCenterLeft:                            _admobBunch._bannerLayout.setGravity(Gravity.CENTER_VERTICAL | Gravity.START);                            break;                        case kBannerGravityBottomLeft:                            _admobBunch._bannerLayout.setGravity(Gravity.BOTTOM | Gravity.START);                            break;                        case kBannerGravityTopCenter:                            _admobBunch._bannerLayout.setGravity(Gravity.TOP | Gravity.CENTER_HORIZONTAL);                            break;                        case kBannerGravityCenter:                            _admobBunch._bannerLayout.setGravity(Gravity.CENTER);                            break;                        case kBannerGravityBottomCenter:                            _admobBunch._bannerLayout.setGravity(Gravity.BOTTOM | Gravity.CENTER_HORIZONTAL);                            break;                        case kBannerGravityTopRight:                            _admobBunch._bannerLayout.setGravity(Gravity.TOP | Gravity.END);                            break;                        case kBannerGravityCenterRight:                            _admobBunch._bannerLayout.setGravity(Gravity.CENTER_VERTICAL | Gravity.END);                            break;                        case kBannerGravityBottomRight:                            _admobBunch._bannerLayout.setGravity(Gravity.BOTTOM | Gravity.END);                            break;                        case kBannerGravityTopLeft:                        default:                            _admobBunch._bannerLayout.setGravity(Gravity.TOP | Gravity.START);                            break;                    }                    _admobBunch._bannerLayout.addView(_admobBunch.adView, new RelativeLayout.LayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT));                }            }        });    }    public static void createInterstitial(final String adUnitID) {        if (_admobBunch.activity != null)        {            _admobBunch.activity.runOnUiThread(new Runnable()            { @Override              public void run()                {                    _admobBunch.interstitial = new InterstitialAd(_admobBunch.activity);                    _admobBunch.interstitial.setAdUnitId(adUnitID);                    _admobBunch.interstitial.setAdListener(new AdListener()                    {                        public void onAdLoaded()                        {                            if (_admobBunch.interstitial.isLoaded())                            {                                Log.d(TAG, "Interstitial ad is ready.");                            }                            else                            {                                Log.d(TAG, "Interstitial ad is not ready.");                            }                        }                        public void onAdFailedToLoad(int errorCode)                        {                            String message = String.format("onAdFailedToLoad (%s)", _admobBunch.getErrorReason(errorCode));                            Log.d(TAG, message);                            long timestamp = System.currentTimeMillis();                            long timeout = timestamp - lastAttemptTime + 2 * 60 * 1000;                            if (timeout <= 0)                            {                                loadInterstitial();                            }                            else                            {                            // run postponed task every approx. every 2 min                                Handler handler = new Handler();                                handler.postDelayed(new Runnable()                                { @Override                                    public void run()                                    {                                        loadInterstitial();                                    }                                }, timeout);                            }                        }                        @Override                        public void onAdClosed()                        { // Load the interstitial ad again                            loadInterstitial();                        }                    });                    loadInterstitial();                } });        }    }    private static void loadInterstitial()    {        if (_admobBunch.interstitial != null)        {            AdRequest adRequest = new AdRequest.Builder().build();            _admobBunch.interstitial.loadAd(adRequest);        }    }    public static void showInterstitial()    { // Загрузка adView с объявлением.        _admobBunch.activity.runOnUiThread(new Runnable()        {            @Override            public void run()            {                if (_admobBunch.interstitial != null && _admobBunch.interstitial.isLoaded())                {                    _admobBunch.interstitial.show();                }            }        });    }    /** Gets a string error reason from an error code. */    private String getErrorReason(int errorCode) {        String errorReason = "";        switch(errorCode) {            case AdRequest.ERROR_CODE_INTERNAL_ERROR:                errorReason = "Internal error";                break;            case AdRequest.ERROR_CODE_INVALID_REQUEST:                errorReason = "Invalid request";                break;            case AdRequest.ERROR_CODE_NETWORK_ERROR:                errorReason = "Network Error";                break;            case AdRequest.ERROR_CODE_NO_FILL:                errorReason = "No fill";                break;        }        return errorReason;    }    @Override    public void setContext(Context context) {        this.context = context;    }    public void setActivity(Activity activity)    {        this.activity = activity;    }    private void registerProcessor(String key, ProcessorEngine.CallHandler callHandler) {        ProcessorEngine.getInstance().registerProcessor("AdmobBunch", key, callHandler);    }}